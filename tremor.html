<!--
@author Fábio Henrique M. Oliveira
-->
<!-- <!DOCTYPE html> -->
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Tremor data collection using Leap Motion</title>
		<meta name="author" content="Fábio Henrique M. Oliveira">
		<link rel="stylesheet" type="text/css" href="tremor.css">
		<script type="text/javascript" src="leap.min.js"></script>
		<script type="text/javascript" src="canvasjs.min.js"></script>
		<script type="text/javascript" src="usefulFunctions.js"></script>
	</head>
	<body>
		<div id="patientData" class="div1">
			Name:
			<input type="text" id="name" value="Fábio Henrique">
			<br>
			<br />
			<input type="radio" name="gender" value="Male" checked="checked">
			Male
			<br>
			<input type="radio" name="gender" value="Female">
			Female
			<br>
			<br />
			Age:
			<input type="number" id="age" value="23"/>
			<br />
		</div>
		<canvas id="canvas"></canvas>
		<button id="saveDataButton" class="button1" onclick="createFile()">
			Save patient data
		</button>
		<br />
		<button id="connectButton" onclick="controller.connect()" disabled="disabled" class="button2">
			Connect
		</button>
		<button id="disconnectButton" onclick="controller.disconnect()" disabled="disabled" class="button2">
			Disconnect
		</button>
		<div id="handChartContainer"></div>
		<textarea id="logTextArea" readonly="true">LOG:</textarea>																																										


		<script type="text/javascript">
            // Get the canvas DOM element
            var canvas = document.getElementById('canvas');

            // Making sure we have the proper aspect ratio for our canvas
            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;

            // Create the context we will use for drawing
            var c = canvas.getContext('2d');

            // Save the canvas width and canvas height
            // as easily accesible variables
            var width = canvas.width;
            var height = canvas.height;

            // Get the textarea DOM element to allow edit before
            var logTextArea = document.getElementById('logTextArea');

            // number of dataPoints visible at any point
            var dataLength = 300;
            // dataPoints
            var dps = [];

            // Charts
            var handChart;
            // var fingerOneChart;
            // var fingerTwoChart;
            // var fingerThreeChart;
            // var fingerFourChart;
            // var fingerFiveChart;

            // Vars to control the time (to use in the charts)
            var firstTimestamp = 0;
            var currentTimestamp = 0;
            var lastTimestamp = 0;
            // My frame id
            var frameId = 0;

            // Qtd frames/second
            var frameRate = 60;
            // Time to wait between frames in microsecond (/1000000 = 0.01 seconds)
            var framePause = (1 / frameRate) * 1000000;
            // Used to control the program loop (using a kind of timer)
            var loopController;

            // Creates our Leap Controller
            var controller = new Leap.Controller({
                enableGestures : false,
                frameEventName : 'deviceFrame'
            });

            //Library to work with files
            var fs = require('fs');

            var projectPath = '/Users/oliveirafhm/Documents/Aptana Studio 3 Workspace/tremor_analysis/';
            var nameField = document.getElementById('name');
            var fileName;

            var buffer = [];
            // 5 * 60
            var bufferSize = 300;

            // Flushs the buffer writing in a file
            function flushBuffer() {
                appendFile(fs, (projectPath + fileName), buffer.toString());
                buffer.length = 0;
            }

            function createFile() {
                fileName = getTodayDate() + ' ' + getTime() + ' ' + removeDiacritics(replaceSpaces(nameField.value, '_')) + '.txt';

                var genderField = document.getElementsByName('gender');
                var gender = genderField[0].checked ? genderField[0].value : genderField[1].value;
                var age = document.getElementById('age');

                var header = 'Name: ' + nameField.value + '\n' + 'Gender: ' + gender + '\n' + 'Age: ' + age.value;
                header += '\nDate: ' + getTodayDate('/');

                appendFile(fs, (projectPath + fileName), header);

                document.getElementById("connectButton").disabled = false;
                document.getElementById("saveDataButton").disabled = true;
            }

            // Initializes the charts
            initHandChart();

            // Tells the controller what to do every time it sees a frame
            function onFrame(frame) {
                //Clears the canvas so we are not drawing multiple frames
                c.clearRect(0, 0, width, height);

                // First we loop through all of the hands that the frame sees
                // frame.hands.length
                for (var i = 0; i < frame.hands.length; i++) {
                    if (i == 0 && frame.valid) {
                        // For each hand we define it
                        var hand = frame.hands[i];

                        if (frameId == 0) {
                            logTextArea.value += '\n--- Updated every ' + usToS(framePause) + ' seconds ---\n\nFirst frame id: ' + frame.id + '	Timestamp: ' + frame.timestamp;
                            logTextArea.value += '\nMy first frame id: ' + frameId + '	Time: ' + currentTimestamp + ' seconds\n';
                            firstTimestamp = frame.timestamp;
                            frameId += 1;
                            lastTimestamp = frame.timestamp;
                                                        
                            appendFile(fs, (projectPath + fileName), ('\nTime: ' + getTime(':') + '\n--\n'));
                        } else {
                            currentTimestamp = usToS((frame.timestamp - firstTimestamp));
                            // logTextArea.value += '\nFrame id: ' + frame.id + '	Timestamp: ' + frame.timestamp;
                            // logTextArea.value += '\nMy frame id: ' + frameId + '	Time: ' + currentTimestamp + ' seconds\n';
                            // To keep textarea scrolled to the bottom when updated
                            logTextArea.scrollTop = logTextArea.scrollHeight;

                            updateHandChart(hand);

                            frameId += 1;
                            lastTimestamp = frame.timestamp;                            
                        }
						buffer.push(currentTimestamp, hand.palmPosition);
                        // and get its position, so that it can be passed through
                        // for drawing the connections
                        var handPos = leapToScene(hand.palmPosition, frame);
                        //var tmpLength = buffer.push([]) - 1;
                        // Loop through all the fingers of the hand we are on
                        for (var j = 0; j < hand.fingers.length; j++) {

                            // Define the finger we are looking at
                            var finger = hand.fingers[j];
                            buffer.push(finger.tipPosition, finger.length);
                            // and get its position in Canvas
                            var fingerPos = leapToScene(finger.tipPosition, frame);

                            /*
                            First Draw the Connection
                            */

                            // Setting up the style for the stroke
                            c.strokeStyle = "#FFA040";
                            c.lineWidth = 3;

                            // Drawing the path
                            c.beginPath();

                            // Move to the hand position
                            c.moveTo(handPos[0], handPos[1]);

                            // Draw a line to the finger position
                            c.lineTo(fingerPos[0], fingerPos[1]);

                            c.closePath();
                            c.stroke();

                            /*
                            Second Draw the Finger
                            */

                            // Setting up the style for the stroke
                            c.strokeStyle = "#39AECF";
                            c.lineWidth = 5;

                            // Creating the path for the finger circle
                            c.beginPath();

                            // Draw a full circle of radius 6 at the finger position
                            c.arc(fingerPos[0], fingerPos[1], 20, 0, Math.PI * 2);

                            c.closePath();
                            c.stroke();

                        }

                        /*
                        Third draw the hand
                        */

                        // Setting up the style for the fill
                        c.fillStyle = "#FF5A40";

                        // Creating the path for the hand circle
                        c.beginPath();

                        // Draw a full circle of radius 10 at the hand position
                        c.arc(handPos[0], handPos[1], 40, 0, Math.PI * 2);

                        c.closePath();
                        c.fill();

                        buffer.push('\n\n');
                        
                        if (buffer.length >= bufferSize) {                            
                            flushBuffer();
                        }
                    }
                }
            }

            // Get frames rolling by connecting the controller
            controller.on('connect', function() {
                logTextArea.value += '\n---Successfully connected---\n';
                // This function uses the time in miliseconds
                loopController = setInterval(function() {
                    onFrame(controller.frame());
                }, usToMs(framePause));
                document.getElementById("disconnectButton").disabled = false;
                document.getElementById("connectButton").disabled = true;
            });

            controller.on('disconnect', function() {
                clearInterval(loopController);
                flushBuffer();
                logTextArea.value += '\nLast frame id: ' + frame.id + '	Timestamp: ' + frame.timestamp;
                logTextArea.value += '\nMy last frame id: ' + frameId + '	Time: ' + currentTimestamp + ' seconds\n';
                logTextArea.value += '\n---Disconnected---\nStopped!\n\nReloads the page to restart the application.\n';
                document.getElementById("disconnectButton").disabled = true;
                // To keep textarea scrolled to the bottom when updated
                logTextArea.scrollTop = logTextArea.scrollHeight;
            });

            controller.on('deviceConnected', function() {
                console.log("A Leap device has been connected.");
            });

            controller.on('deviceDisconnected', function() {
                console.log("A Leap device has been disconnected.");
            });

            function initHandChart() {

                handChart = new CanvasJS.Chart("handChartContainer", {
                    zoomEnabled : true,
                    title : {
                        text : "Palm Velocity",
                        //fontSize : "19",
                    },
                    data : [{
                        type : "line",
                        color : "#FF5A40",
                        name : "Palm velocity (norm)",
                        showInLegend : true,
                        dataPoints : dps,
                    }],
                    axisX : {
                        title : "seconds",
                        //interval: framePause/1000000,
                        intervalType : "second",
                        //suffix: " s",
                    },
                    axisY : {
                        title : "millimeters",
                        minimum : 0,
                        maximum : 500,
                        //suffix: " mm",
                    },
                    toolTip : {
                        enabled : false,
                    },
                    // legend : {
                    // fontSize : 14,
                    // }
                });
            }

            function updateHandChart(hand) {
                dps.push({
                    x : currentTimestamp,
                    y : calc3DVectorNorm(hand.palmVelocity)
                });
                if (dps.length > dataLength) {
                    dps.shift();
                }
                handChart.render();
            }

		</script>
	</body>
</html>