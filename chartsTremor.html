<!--
@author Fábio Henrique M. Oliveira
-->
<!-- <!DOCTYPE html> -->
<html lang="en">
	<head>
		<meta charset="utf-8">
		<title>Tremor analysis using Leap Motion</title>
		<meta name="author" content="Fábio Henrique M. Oliveira">
		<style>
			#canvas {
				float: right;
				width: 50%;
				height: 50%;
				border: 1px solid #000000;
			}
			/*#connectButton {
			 position: relative;
			 bottom: 0 px;
			 }*/
			#logTextArea {
				float: right;
				width: 50%;
				height: 50%;
			}
			#chartContainer{
				float: left;
				width: 45%;
				height: 45%;				
			}
		</style>
		<script type="text/javascript" src="leap.min.js"></script>
		<script type="text/javascript" src="canvasjs.min.js"></script>
		<script type="text/javascript" src="usefulFunctions.js"></script>
	</head>
	<body>

		<canvas id="canvas" ></canvas>
		<button id="connectButton" onclick="controller.connect()">
			Connect
		</button>
		<button id="resumeButton" onclick="resume()" disabled="disabled">
			Resume
		</button>
		<button id="pauseButton" onclick="pause()" disabled="disabled">
			Pause
		</button>
		<button id="disconnectButton" onclick="controller.disconnect()" disabled="disabled">
			Disconnect
		</button>
		<div id="chartContainer"></div>
		<textarea id="logTextArea" readonly="true">LOG:</textarea>																										

		<script>
            // Get the canvas DOM element
            var canvas = document.getElementById('canvas');

            // Making sure we have the proper aspect ratio for our canvas
            canvas.width = canvas.clientWidth;
            canvas.height = canvas.clientHeight;

            // Create the context we will use for drawing
            var c = canvas.getContext('2d');

            // Save the canvas width and canvas height
            // as easily accesible variables
            var width = canvas.width;
            var height = canvas.height;

            // Get the textarea DOM element to allow edit before
            var logTextArea = document.getElementById('logTextArea');

            // Creating a global Frame variable that we can access
            // throughout the program
            //var frame;

            // number of dataPoints visible at any point
            var dataLength = 300;
            // dataPoints
            var dps = [];
            // Chart
            var chart;

            // Vars to control the time (to use in the charts)
            var firstTimestamp = 0;
            var currentTimestamp = 0;
            var lastTimestamp = 0;
            // My frame id
            var frameId = 0;

            // Qtd frames/second
            var frameRate = 60;
            // Time to wait between frames in microsecond (/1000000 = 0.01 seconds)
            var framePause = (1 / frameRate) * 1000000;
            // Used to control the program loop (using a kind of timer)
            var loopController;

            // Creates our Leap Controller
            var controller = new Leap.Controller({
                enableGestures : false,
                frameEventName : 'deviceFrame'
            });
            //console.log(controller.frame());
            // Initializes the chart
            initChart();

            // Tells the controller what to do every time it sees a frame
            function onFrame(frame) {
                //Clears the canvas so we are not drawing multiple frames
                c.clearRect(0, 0, width, height);

                // First we loop through all of the hands that the frame sees
                // TODO: I need to restrict it for just one hand
                for (var i = 0; i < frame.hands.length; i++) {

                    // For each hand we define it
                    var hand = frame.hands[i];

                    if (frameId == 0 && frame.valid) {
                        logTextArea.value += '\n--- Updated every ' + framePause / 1000000 + ' seconds ---\n\nFrame id: ' + frame.id + '	Timestamp: ' + frame.timestamp + '\nHand time visible: ' + hand.timeVisible + ' seconds';
                        logTextArea.value += '\nMy frame id: ' + frameId + '	Time: ' + currentTimestamp + ' seconds\n';
                        firstTimestamp = frame.timestamp;
                        frameId += 1;
                        lastTimestamp = frame.timestamp;
                    } else {
                        currentTimestamp = (frame.timestamp - firstTimestamp) / 1000000;
                        logTextArea.value += '\nFrame id: ' + frame.id + '	Timestamp: ' + frame.timestamp + '\nHand time visible: ' + hand.timeVisible + ' seconds';
                        logTextArea.value += '\nMy frame id: ' + frameId + '	Time: ' + currentTimestamp + ' seconds\n';
                        // To keep textarea scrolled to the bottom when updated
                        logTextArea.scrollTop = logTextArea.scrollHeight;

                        updateChart(hand);

                        frameId += 1;
                        lastTimestamp = frame.timestamp;
                    }

                    // and get its position, so that it can be passed through
                    // for drawing the connections
                    var handPos = leapToScene(hand.palmPosition, frame);

                    // Loop through all the fingers of the hand we are on
                    for (var j = 0; j < hand.fingers.length; j++) {

                        // Define the finger we are looking at
                        var finger = hand.fingers[j];

                        // and get its position in Canvas
                        var fingerPos = leapToScene(finger.tipPosition, frame);

                        /*
                        First Draw the Connection
                        */

                        // Setting up the style for the stroke
                        c.strokeStyle = "#FFA040";
                        c.lineWidth = 3;

                        // Drawing the path
                        c.beginPath();

                        // Move to the hand position
                        c.moveTo(handPos[0], handPos[1]);

                        // Draw a line to the finger position
                        c.lineTo(fingerPos[0], fingerPos[1]);

                        c.closePath();
                        c.stroke();

                        /*
                        Second Draw the Finger
                        */

                        // Setting up the style for the stroke
                        c.strokeStyle = "#39AECF";
                        c.lineWidth = 5;

                        // Creating the path for the finger circle
                        c.beginPath();

                        // Draw a full circle of radius 6 at the finger position
                        c.arc(fingerPos[0], fingerPos[1], 20, 0, Math.PI * 2);

                        c.closePath();
                        c.stroke();

                    }

                    /*
                    Third draw the hand
                    */

                    // Setting up the style for the fill
                    c.fillStyle = "#FF5A40";

                    // Creating the path for the hand circle
                    c.beginPath();

                    // Draw a full circle of radius 10 at the hand position
                    c.arc(handPos[0], handPos[1], 40, 0, Math.PI * 2);

                    c.closePath();
                    c.fill();

                }

            }


            controller.on('connect', function() {
                logTextArea.value += '\n---Successfully connected---\nCollecting data...';
                // This function uses the time in miliseconds
                loopController = setInterval(function() {
                    onFrame(controller.frame());
                }, (framePause / 1000));
                document.getElementById("disconnectButton").disabled = false;
                //document.getElementById("resumeButton").disabled = false;
                document.getElementById("pauseButton").disabled = false;
                document.getElementById("connectButton").disabled = true;
            });

            controller.on('disconnect', function() {
            	clearInterval(loopController);
                logTextArea.value += '\n---Disconnected---\nStopped!';
                document.getElementById("disconnectButton").disabled = true;
                document.getElementById("resumeButton").disabled = true;
                document.getElementById("pauseButton").disabled = true;
                document.getElementById("connectButton").disabled = true;
                // To keep textarea scrolled to the bottom when updated
                logTextArea.scrollTop = logTextArea.scrollHeight;
            });

            function resume() {
                logTextArea.value += '\n---Continuing---';
                loopController = setInterval(function() {
                    onFrame(controller.frame());
                }, (framePause / 1000));
                document.getElementById("resumeButton").disabled = true;
                document.getElementById("pauseButton").disabled = false;                
            }

            function pause() {
                clearInterval(loopController);
                logTextArea.value += '\n---Paused---';
                document.getElementById("resumeButton").disabled = false;
                document.getElementById("pauseButton").disabled = true;
                // To keep textarea scrolled to the bottom when updated
                logTextArea.scrollTop = logTextArea.scrollHeight;
            }

            // Get frames rolling by connecting the controller
            //controller.connect();

            function initChart() {

                chart = new CanvasJS.Chart("chartContainer", {
                    zoomEnabled : true,
                    title : {
                        text : "Palm Velocity",
                        fontSize : "19",
                    },
                    data : [{
                        type : "line",
                        color: "#FF5A40",
                        name : "Palm velocity (norm)",
                        showInLegend : true,
                        dataPoints : dps,
                    }],
                    axisX : {
                        title : "seconds",
                        //interval: framePause/1000000,
                        intervalType : "second",
                        //suffix: " s",
                    },
                    axisY : {
                        title : "millimeters",
                        minimum : 0,
                        maximum : 500,
                        //suffix: " mm",
                    },
                    legend : {
                        fontSize : 14,
                    }
                });
            }

            function updateChart(hand) {

                dps.push({
                    x : currentTimestamp,
                    y : normalize3DVector(hand.palmVelocity)
                });

                if (dps.length > dataLength) {
                    dps.shift();
                }

                chart.render();
            }

            // Get the velocity of the hand (norm)
            function normalize3DVector(vector) {
                return Math.sqrt(vector[0] * vector[0] + vector[1] * vector[1] + vector[2] * vector[2]);
            }
		</script>

	</body>
</html>